$(document).ready(function(){var e={siteID:"",endpoint:"",init:function(t){return e.siteID=t,e.endpoint="/index.cfm/_api/json/v1/"+e.siteID+"/",e},getEndpoint:function(){return e.endpoint},all:function(e){Mura.get(this.getEndpoint()).then(function(t){t.items=t.data.items,e(t)})},getPropertiesAsJSON:function(e,t){var i=this,a={};console.log(arguments),Mura.get(i.getEndpoint()+t+"/properties").then(function(t){console.log("GET PROP"),console.log(t),t.error?a={}:((a=t.data).links&&delete a.links,i.processProperties(a)),e(a)})},get:function(e,t,i,a,r){var o=this,n={},l=i||"new";if("new"==l)Mura.getEntity(t).new().then(function(t){n.model=t.getAll(),n.model._displaylist=[],n.entity=t,t.get("properties").then(function(t){n.properties=t.getAll().items;for(var i=0;i<n.properties.length;i++)n.properties[i].listview&&n.model._displaylist.push(n.properties[i]);e(n)})});else Mura.getEntity(t).loadBy("id",l).then(function(t){n.model=t.getAll(),n.model._displaylist=[],n.entity=t,t.get("properties").then(function(t){n.properties=t.getAll().items,o.processProperties(n);for(var i=0;i<n.properties.length;i++)n.properties[i].listview?n.model._displaylist.push(n.properties[i]):n.properties[i].fieldtype;e(n)},function(e){console.log("error"),console.log(e)})})},processProperties:function(e){var t=-1e4;e.properties.sort(this.propertySort);for(var i=0;i<e.properties.length;i++){var a=JSON.parse(JSON.stringify(e.properties[i]));a.pos=i,"null"==a.default&&(a.default=""),a.orderno||(a.orderno=t++),a.optionlist&&a.optionlist.length&&Array.isArray(a.optionlist)&&(a.optionlist=prop.optionlist.join("^")),a.optionvaluelist&&a.optionvaluelist.length&&Array.isArray(a.optionvaluelist)&&(a.optionvaluelist=a.optionvaluelist.join("^")),a.rendertype&&""!=a.rendertype||(a.rendertype=this.getRenderType(a)),a.displayname&&""!=a.displayname||(a.displayname=a.name),a.name&&""!=a.name||(a.name=a.displayname),"group"==e.entityname&&"userid"==a.name&&(a.displayname="groupid"),"file"==a.rendertype&&(a.length=250),e.properties[i]=a}},propertySort:function(e,t){return e.orderno||(e.orderno=0),t.orderno||(t.orderno=0),parseInt(e.orderno)-parseInt(t.orderno)},getRenderType:function(e){return"text"==e.datatype?"textarea":"int"==e.datatype&&e.default<=1?"checkbox":"textfield"},removeInvalidText:function(e){return e.replace(/"/g,"'")}},t=new e.init(Mura.siteid);Vue.component("assembler-attributes-form-template",{template:"#assembler-attributes-form-template",props:["model"],mounted:function(){},methods:{removeInvalidText:function(e){return t.removeInvalidText(e)},checkIDProp:function(){console.log(this),console.log(this.$parent),this.$parent.checkIDProp()}}}),Vue.component("assembler-related-form-template",{template:"#assembler-related-form-template",props:["datatypes","data"],mounted:function(){this.data.relatesto.length&&t.getPropertiesAsJSON(this.onLoadComplete,this.data.relatesto)},data:function(){return{relatedprops:{}}},methods:{onFKColumnChange:function(){data.loadkey||"groupid"!=data.fkcolumn||"group"!=data.relatesto||(data.loadkey="userid")},clickUpdateRelated:function(){this.$forceUpdate(),this.$parent.clickUpdateRelated()},clickDeleteRelated:function(){this.$forceUpdate(),this.$parent.clickDeleteRelated()},clickCancel:function(){this.$parent.clickCancel()},getRelatesToFields:function(e){t.getPropertiesAsJSON(this.onLoadComplete,e.target.value)},onLoadComplete:function(e){var t=[];for(var i in e.properties)e.properties[i].cfc||e.properties[i].relatesto||("group"==e.entityname&&"userid"==e.properties[i].name&&(e.properties[i].name="groupid"),console.log(e.properties[i]),t.push(e.properties[i]));this.relatedprops=t}}}),Vue.component("assembler-template",{template:"#assembler-template",props:["data","rendertypes","datatypes","fieldtypes","model","isupdate"],created:function(){},destroyed:function(){},updated:function(){},methods:{checkIDProp:function(){console.log(this),console.log(this.$parent),this.$parent.checkIDProp()},clickEditProperty:function(e){this.$parent.clickEditProperty(e)},clickEditRelated:function(e){this.$parent.clickEditRelated(e)},clickAddRelated:function(){this.$parent.clickAddRelated()},clickAddProperty:function(){this.$parent.clickAddProperty()},clickCancel:function(){this.$parent.clickCancel()},clickUpdateProperty:function(){this.$forceUpdate(),this.$parent.clickUpdateProperty()},clickDeleteProperty:function(){this.$forceUpdate(),this.$parent.clickDeleteProperty()},removeInvalidText:function(e){return t.removeInvalidText(e)},removeInvalidText:function(e){return t.removeInvalidText(e)}}}),Vue.component("assembler-property-form-template",{template:"#assembler-property-form-template",props:["data","rendertypes","datatypes","fieldtypes"],methods:{clickCancel:function(){this.$parent.clickCancel()},clickUpdateProperty:function(){this.$forceUpdate(),this.$parent.clickUpdateProperty()},clickDeleteProperty:function(){this.$forceUpdate(),this.$parent.clickDeleteProperty()},removeInvalidText:function(e){return t.removeInvalidText(e)},removeInvalidText:function(e){return t.removeInvalidText(e)}}}),Vue.component("assembler-related-template",{template:"#assembler-related-template",props:["model"],methods:{}}),Vue.component("assembler-property-template",{template:"#assembler-property-template",props:["model"],methods:{clickEditProperty:function(e){this.$parent.clickEditProperty(e)},clickEditRelated:function(e){this.$parent.clickEditRelated(e)}}}),Assembler=new Vue({el:"#container-assembler",data:{alldynamicobjects:[],staticmodel:{},isupdate:!1,isvisible:!1,model:{entityname:"",displayname:"",table:"",historical:!1,orderby:"",bundleable:!1,scaffold:!0,dynamic:!0,public:!1,properties:[]},data:{},propertymodel:{},relatedmodel:{},entityissaved:!1,currentView:"assembler-template",rendertypes:[],datatypes:[],fieldtypes:[]},mounted:function(){t.all(this.setDynamicObjects);this.staticmodel={entityname:"",displayname:"",table:"",historical:!1,orderby:"",bundleable:!1,scaffold:!0,dynamic:!0,public:!1,properties:[{default:"default",required:!0,rendertype:"hidden",filter:!1,fieldtype:"",dynamic:!0,orderno:2,listview:!1,displayname:"siteid",html:"",datatype:"varchar",length:"25",name:"siteid",nullable:!1}]},this.model=JSON.parse(JSON.stringify(this.staticmodel)),this.checkIDProp(),this.propertymodel={default:"",required:!1,rendertype:"textfield",filter:!1,fieldtype:"",dynamic:!0,orderno:1,listview:!1,displayname:"",html:"",datatype:"varchar",length:"",name:"",nullable:!0},this.relatedmodel={default:"",fieldtype:"one-to-many",renderfield:"",fkcolumn:"",cascade:"none",loadkey:"",name:"",displayname:"",relatesto:"",datatype:"char",length:"35",nullable:!0},this.rendertypes=[{name:"textfield",label:"Text Field"},{name:"textarea",label:"Text Area"},{name:"htmleditor",label:"HTML Editor"},{name:"dropdown",label:"Dropdown"},{name:"checkbox",label:"Checkbox"},{name:"radio",label:"Radio"},{name:"hidden",label:"Hidden"},{name:"file",label:"File"},{name:"null",label:"Do not render"}],this.datatypes=[{name:"varchar",label:"VarChar"},{name:"text",label:"Text"},{name:"int",label:"Int"},{name:"float",label:"Float"},{name:"double",label:"Double"},{name:"int",label:"Boolean"},{name:"datetime",label:"DateTime"},{name:"any",label:"Any"}],this.fieldtypes=[{name:"",label:""},{name:"index",label:"Index"}];var e=Mura.getQueryStringParams(location.search);this.entityissaved=!1,e.entityname&&(this.entityissaved=!0,this.loadEntity(e.entityname))},destroyed:function(){},watch:{handler:function(){}},methods:{clickSave:function(e){var i=this;Mura("#load-spin").show();for(var a=1;a<this.model.properties.length;a++)this.model.properties[a].orderno=a;var r=JSON.parse(JSON.stringify(this.model));for(a=0;a<r.properties.length;a++){var o=r.properties[a];for(var n in delete o.pos,o.optionlist&&o.optionlist.length&&Array.isArray(o.optionlist)&&(o.optionlist=o.optionlist.join("^")),o.optionvaluelist&&o.optionvaluelist.length&&Array.isArray(o.optionvaluelist)&&(o.optionvaluelist=o.optionvaluelist.join("^")),"text"==o.datatype&&delete o.default,"file"==o.rendertype&&(o.datatype="varchar",o.length=250),o)""==o[n]&&delete o[n]}$("body").append('<div id="action-modal" class="modal-backdrop fade in"></div>'),$("#action-modal").spin(spinnerArgs),Mura.declareEntity(r).then(function(e){Mura.getEntity(r.entityname).checkSchema().then(function(){i.entityissaved=!0,$("#action-modal").stop().remove(),Mura("#alert-assembler-saved").html('<div class="alert alert-success"><span>Entity definition saved</span><button type="button" class="close" data-dismiss="alert"><i class="mi-close"></i></button></div>'),t.all(i.setDynamicObjects),Assembler.loadEntity(r.entityname)})})},clickDelete:function(){var e=this;confirmDialog("Delete dynamic entity?",function(){confirmDialog("Delete entity schema from database?",function(){$("body").append('<div id="action-modal" class="modal-backdrop fade in"></div>'),$("#action-modal").spin(spinnerArgs),Mura.getEntity(e.model.entityname).undeclareEntity(!0).then(function(){location.href="./?muraAction=cArch.list&activeTab=2&"+Mura.siteid})},function(){$("body").append('<div id="action-modal" class="modal-backdrop fade in"></div>'),$("#action-modal").spin(spinnerArgs),Mura.getEntity(e.model.entityname).undeclareEntity(!1).then(function(){location.href="./?muraAction=cArch.list&activeTab=2&"+Mura.siteid})})})},clickAddRelated:function(){this.isupdate=!1,this.data=JSON.parse(JSON.stringify(this.relatedmodel)),this.data.fkcolumn&&"primaryKey"==this.data.fkcolumn&&(this.data.fkcolumn=""),this.data.loadkey&&"primaryKey"==this.data.loadkey&&(this.data.loadkey=""),this.currentView="assembler-related-form-template"},clickAddProperty:function(){this.isupdate=!1,this.data=JSON.parse(JSON.stringify(this.propertymodel)),this.currentView="assembler-property-form-template"},clickUpdateProperty:function(){var e=JSON.parse(JSON.stringify(this.data));null==e.pos?(e.pos=this.model.properties.length,e.orderno=e.pos+1,this.model.properties.push(e)):this.model.properties.splice(e.pos,1,e),this.data={},this.currentView="assembler-template"},clickDeleteProperty:function(){var e=JSON.parse(JSON.stringify(this.data));confirm("Are you sure you want to delete this property?")&&(this.model.properties.splice(e.pos,1),this.data={},this.currentView="assembler-template")},clickUpdateRelated:function(){var e=JSON.parse(JSON.stringify(this.data));e.loadkey&&"primaryKey"==e.loadkey&&(e.loadkey=""),e.fkcolumn&&"primaryKey"==e.fkcolumn&&(e.fkcolumn=""),null==e.pos?(e.pos=this.model.properties.length,e.orderno=e.pos+1,this.model.properties.push(e)):this.model.properties.splice(e.pos,1,e),this.data={},this.currentView="assembler-template"},clickDeleteRelated:function(){var e=JSON.parse(JSON.stringify(this.data));confirm("Are you sure you want to delete this relationship?")&&(this.model.properties.splice(e.pos,1),this.data={},this.currentView="assembler-template")},clickCancel:function(){this.data={},this.currentView="assembler-template"},clickClear:function(){confirm("Clear the form? Unsaved changes will be lost.")&&(this.data={},this.model=JSON.parse(JSON.stringify(this.staticmodel)),this.currentView="assembler-template",this.checkIDProp())},clickEditProperty:function(e){this.isupdate=!0,this.data=JSON.parse(JSON.stringify(this.model.properties[e])),this.currentView="assembler-property-form-template"},clickEditRelated:function(e){this.isupdate=!0,this.data=JSON.parse(JSON.stringify(this.model.properties[e])),console.log(this.data),this.data.loadkey&&"primaryKey"==this.data.loadkey&&(this.data.loadkey=""),this.data.fkcolumn&&"primaryKey"==this.data.fkcolumn&&(this.data.fkcolumn=""),this.currentView="assembler-related-form-template"},clickLoadEntity:function(){Mura("#load-spin").show(),this.data={},this.currentView="assembler-template",this.model=JSON.parse(JSON.stringify(this.staticmodel));var e=$("#loadentity").val();if(!e.length)return Mura("#load-spin").hide(),void this.checkIDProp();this.loadEntity(e)},loadEntity:function(e){console.log("LOADING"),t.getPropertiesAsJSON(this.onLoadComplete,e)},onLoadComplete:function(e){if(Mura("#load-spin").hide(),!e.dynamic||1!=e.dynamic&&"true"!=e.dynamic)return this.checkIDProp(),void alert("Sorry, you can only edit dynamic Masa CMS ORM objects.");this.model=e,this.checkIDProp()},setDynamicObjects:function(e){this.alldynamicobjects=e.items},checkIDProp:function(){var e={};this.model.entityname=this.model.entityname.replace(/[^0-9a-z]/gi,"");for(var t=0;t<this.model.properties.length;t++){var i=this.model.properties[t];if(i.fieldtype&&"id"==i.fieldtype)return void(this.entityissaved||(i.name=this.model.entityname.toLowerCase()+"id",i.displayname=i.name))}e.fieldtype="id",e.orderno=-1e5,e.pos=-1e5,e.name=this.model.entityname+"id",this.model.properties.unshift(e)},show:function(){this.data={},this.model=JSON.parse(JSON.stringify(this.staticmodel)),this.currentView="assembler-template",this.checkIDProp(),this.isvisible=!0},hide:function(){this.isvisible=!1}}}),setTimeout(function(){Mura(".mura-actions").show()},250)});